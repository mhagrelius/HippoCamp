name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  merge_group:
    types: [checks_requested]

permissions:
  contents: read
  pull-requests: read

jobs:
  commitlint:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Lint Commit Messages
      uses: wagoid/commitlint-github-action@v6
      with:
        configFile: commitlint.config.mjs
        failOnWarnings: false
        failOnErrors: true

  git-flow-validation:
    name: Validate Git-Flow Rules
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Check Branch Strategy Compliance
      run: |
        echo "üîç Validating Git-Flow compliance..."
        echo "Source branch: ${{ github.head_ref }}"
        echo "Target branch: ${{ github.base_ref }}"
        
        # Block direct PRs to main (except from develop or hotfix branches)
        if [[ "${{ github.base_ref }}" == "main" ]]; then
          if [[ "${{ github.head_ref }}" == "develop" ]]; then
            echo "‚úÖ Release PR from develop to main - allowed"
          elif [[ "${{ github.head_ref }}" =~ ^hotfix/.+ ]]; then
            echo "‚úÖ Emergency hotfix PR to main - allowed"
          else
            echo "‚ùå Direct PRs to 'main' are not allowed!"
            echo "üí° Follow git-flow: use 'develop' for releases or 'hotfix/' for emergency fixes"
            exit 1
          fi
        fi
        
        echo "‚úÖ Git-flow branch strategy is valid"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      
    - name: Run tests
      run: dotnet test --no-build --configuration Release --verbosity normal
